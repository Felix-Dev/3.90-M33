#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdarg.h>
#include <unistd.h>

#include "types.h"

u8 nem_exploit[0x100] = 
{
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xD0, 0xBF, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x52, 0xA1, 0x05, 0xCD, 0x3A, 0x52, 0x59, 0x28, 0x0A, 0xD1, 0x31, 0xF1, 0xBD, 0x87, 0x2E, 0xCC, 
	0x14, 0xDA, 0x02, 0x2F, 0x77, 0x88, 0xC7, 0x66, 0xF3, 0x32, 0x07, 0xBD, 0x1A, 0x08, 0x9E, 0x4C, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x04, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xC6, 0x5F, 0x74, 0x12, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void ErrorExit(char *fmt, ...)
{
	va_list list;
	char msg[256];	

	va_start(list, fmt);
	vsprintf(msg, fmt, list);
	va_end(list);

	printf(msg);
	exit(-1);
}

u8 myblock[0x4000];
u8 buffer[1*1024*1024];

int main()
{
	FILE *i, *o;
	int size;
	
	i = fopen("iplboot.bin", "rb");	
	if (!i)
	{
		ErrorExit("Cannot open iplboot.bin\n");
	}

	memset(myblock, 0, 0x4000);
	memcpy(myblock, nem_exploit, 0x100);
	fread(myblock+0x100, 1, 0xF00, i);

	fclose(i);

	i = fopen("patch.bin", "rb");
	if (!i)
	{
		ErrorExit("Cannot open patch.bin\n");
	}

	fread(myblock+0x1000, 1, 0x3000, i);
	fclose(i);

	i = fopen("ipl.bin", "rb");
	if (!i)
	{
		ErrorExit("Cannot open iplboot.bin\n");
	}

	o = fopen("ipl_result.bin", "wb");
	if (!o)
	{
		fclose(i);
		ErrorExit("Cannot create ipl_result.bin\n");
	}

	fwrite(myblock, 1, 0x4000, o);
	size = fread(buffer, 1, sizeof(buffer), i);
	
	fwrite(buffer, 1, size, o);	

	fclose(i);
	fclose(o);

	printf("Done.\n");

	
	return 0;
}

