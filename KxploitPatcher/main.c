#include <pspsdk.h>
#include <pspkernel.h>
#include <psploadexec.h>
#include <psputils.h>
#include <pspctrl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdarg.h>
#include <malloc.h>


PSP_MODULE_INFO("NokxploitPatcher", 0x1000, 1, 0);

PSP_MAIN_THREAD_ATTR(0);

#define printf pspDebugScreenPrintf


void ErrorExit(int milisecs, char *fmt, ...)
{
	va_list list;
	char msg[256];	

	va_start(list, fmt);
	vsprintf(msg, fmt, list);
	va_end(list);

	printf(msg);

	sceKernelDelayThread(milisecs*1000);
	sceKernelExitGame();
}

int WriteFile(char *file, void *buf, int size)
{
	SceUID fd = sceIoOpen(file, PSP_O_WRONLY | PSP_O_CREAT | PSP_O_TRUNC, 0777);

	if (fd < 0)
	{
		return -1;
	}

	int written = sceIoWrite(fd, buf, size);
	
	if (sceIoClose(fd) < 0)
		return -1;

	return written;
}

char buf[256*1024] __attribute__((aligned(64)));
char buf2[256*1024] __attribute__((aligned(64)));

/* Decrypt a single PRX file */
int DecryptPRX(u8 *in, int insize, u8 *out)
{
	int ret = -1;
	int bytes_read = insize;
	
	u8 check[0x100];
	u32 size;
	
	memset(check, 0, sizeof(check));
	sceKernelCheckExecFile(in, check);
	/* Get size of data block */
	size = *(unsigned int *) (check+0x5C);

	/* Check if we managed to decrypt the file */
	if(*(unsigned short *)(check+0x5a) & 1)
	{
		/* Set decrypt buffer pointer */
		*(unsigned int*)(check+0x24) = (unsigned int) out;
		sceKernelCheckExecFile(in, check);		
	}
	else
	{
		return size;
	}

	if(size >= 0)
	{
		ret = size;			
	}
	
	return ret;
}

int ReadFile(char *file, void *buf, int size)
{
	SceUID fd = sceIoOpen(file, PSP_O_RDONLY, 0);
	
	if (fd < 0)
		return fd;

	int read = sceIoRead(fd, buf, size);
	sceIoClose(fd);

	return read;
}

/*int PatchLoadCore()
{
	int size = ReadFile("flash0:/kd/loadcore.prx", buf, sizeof(buf));
	if (size != 41888)
	{
		return -1;
	}

	size = DecryptPRX(buf, size, buf2);
	if (size != 41548)
	{
		printf("2\n");
		return -1;
	}

	_sw(0, (u32)(buf2+0x28CC));
	_sw(0x52021, (u32)(buf+0x28DC));
	_sw(0x240D0001, (u32)(buf+0x3060));

	sceKernelDcacheWritebackAll();
	sceKernelIcacheClearAll();

	if (WriteFile("flash0:/kd/loadcorep.prx", buf2, size) != size)
	{
		printf("3\n");
		return -1;
	}

	return 0;
}*/

int PatchModuleMgr()
{
	int size = ReadFile("flash0:/kd/modulemgr.prx", buf, sizeof(buf));
	if (size != 16336)
	{
		return -1;
	}

	size = DecryptPRX(buf, size, buf2);
	if (size != 37676)
	{
		return -1;
	}

	_sw(0x1000002A, (u32)(buf2+0x3FA8));

	sceKernelDcacheWritebackAll();
	sceKernelIcacheClearAll();

	if (WriteFile("flash0:/kd/modulemgrp.prx", buf2, size) != size)
		return -1;

	return 0;
}

int CheckFirmware()
{
	u8 md5_game[] =
	{
		0x83, 0x95, 0x0D, 0x66, 0x78, 0xAF, 0x8C, 0xB7, 
		0x58, 0xEB, 0x39, 0xA7, 0x87, 0x99, 0xFA, 0xCE
	};

	u8 md5[16];
	
	if (sceKernelDevkitVersion() != 0x01050001)
		return -1;

	int size = ReadFile("flash0:/kd/pspbtcnf_game.txt", buf, sizeof(buf));
	
	if (size != 1296)
		return -1;

	sceKernelUtilsMd5Digest(buf, size, md5);

	if (memcmp(md5, md5_game, 16) != 0)
		return -1;

	if (sceKernelFindModuleByName("SystemCtrl150"))
		return -1;

	return 0;
}

u8 pspbtcnf_game[972] = 
{
	0x2F, 0x6B, 0x64, 0x2F, 0x73, 0x79, 0x73, 0x6D, 0x65, 0x6D, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 
	0x6B, 0x64, 0x2F, 0x6C, 0x6F, 0x61, 0x64, 0x63, 0x6F, 0x72, 0x65, 0x2E, 0x70, 0x72, 0x78, 0x0A, 
	0x2F, 0x6B, 0x64, 0x2F, 0x65, 0x78, 0x63, 0x65, 0x70, 0x74, 0x69, 0x6F, 0x6E, 0x6D, 0x61, 0x6E, 
	0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x69, 0x6E, 0x74, 0x65, 0x72, 0x72, 0x75, 
	0x70, 0x74, 0x6D, 0x61, 0x6E, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x73, 0x79, 
	0x73, 0x63, 0x6C, 0x69, 0x62, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x74, 0x68, 
	0x72, 0x65, 0x61, 0x64, 0x6D, 0x61, 0x6E, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 
	0x64, 0x6D, 0x61, 0x63, 0x6D, 0x61, 0x6E, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 
	0x73, 0x79, 0x73, 0x74, 0x69, 0x6D, 0x65, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 
	0x2F, 0x69, 0x6F, 0x66, 0x69, 0x6C, 0x65, 0x6D, 0x67, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 
	0x6B, 0x64, 0x2F, 0x75, 0x61, 0x72, 0x74, 0x34, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 
	0x2F, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 
	0x2F, 0x73, 0x74, 0x64, 0x69, 0x6F, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x75, 
	0x74, 0x69, 0x6C, 0x73, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6D, 0x65, 0x6D, 
	0x6C, 0x6D, 0x64, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6D, 0x6F, 0x64, 0x75, 
	0x6C, 0x65, 0x6D, 0x67, 0x72, 0x70, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x69, 
	0x6E, 0x69, 0x74, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6C, 0x6F, 0x61, 0x64, 
	0x65, 0x78, 0x65, 0x63, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x73, 0x79, 0x73, 
	0x72, 0x65, 0x67, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x67, 0x70, 0x69, 0x6F, 
	0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x70, 0x77, 0x6D, 0x2E, 0x70, 0x72, 0x78, 
	0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x69, 0x32, 0x63, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 
	0x2F, 0x64, 0x6D, 0x61, 0x63, 0x70, 0x6C, 0x75, 0x73, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 
	0x64, 0x2F, 0x6C, 0x63, 0x64, 0x63, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x65, 
	0x6D, 0x63, 0x5F, 0x73, 0x6D, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x65, 0x6D, 
	0x63, 0x5F, 0x64, 0x64, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x67, 0x65, 
	0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x69, 0x64, 0x73, 0x74, 0x6F, 0x72, 0x61, 
	0x67, 0x65, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x73, 0x79, 0x73, 0x63, 0x6F, 
	0x6E, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x72, 0x74, 0x63, 0x2E, 0x70, 0x72, 
	0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6C, 0x66, 0x61, 0x74, 0x66, 0x73, 0x2E, 0x70, 0x72, 0x78, 
	0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x63, 0x6C, 0x6F, 0x63, 0x6B, 0x67, 0x65, 0x6E, 0x2E, 0x70, 0x72, 
	0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x63, 0x6F, 0x64, 0x65, 0x63, 0x2E, 0x70, 0x72, 0x78, 0x0A, 
	0x2F, 0x6B, 0x64, 0x2F, 0x61, 0x75, 0x64, 0x69, 0x6F, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 
	0x64, 0x2F, 0x64, 0x69, 0x73, 0x70, 0x6C, 0x61, 0x79, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 
	0x64, 0x2F, 0x63, 0x74, 0x72, 0x6C, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6C, 
	0x65, 0x64, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x68, 0x70, 0x72, 0x65, 0x6D, 
	0x6F, 0x74, 0x65, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x70, 0x6F, 0x77, 0x65, 
	0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6D, 0x65, 0x62, 0x6F, 0x6F, 0x74, 
	0x65, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6D, 0x65, 0x5F, 0x77, 0x72, 
	0x61, 0x70, 0x70, 0x65, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x75, 0x73, 
	0x62, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6F, 0x70, 0x65, 0x6E, 0x70, 0x73, 
	0x69, 0x64, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x73, 0x69, 0x72, 0x63, 0x73, 
	0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6D, 0x65, 0x64, 0x69, 0x61, 0x6D, 0x61, 
	0x6E, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x61, 0x74, 0x61, 0x2E, 0x70, 0x72, 
	0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x75, 0x6D, 0x64, 0x6D, 0x61, 0x6E, 0x2E, 0x70, 0x72, 0x78, 
	0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x62, 0x6C, 0x6B, 0x64, 0x65, 0x76, 0x2E, 0x70, 0x72, 0x78, 0x0A, 
	0x2F, 0x6B, 0x64, 0x2F, 0x75, 0x6D, 0x64, 0x39, 0x36, 0x36, 0x30, 0x2E, 0x70, 0x72, 0x78, 0x0A, 
	0x2F, 0x6B, 0x64, 0x2F, 0x69, 0x73, 0x6F, 0x66, 0x73, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 
	0x64, 0x2F, 0x6D, 0x73, 0x63, 0x6D, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x6D, 
	0x73, 0x73, 0x74, 0x6F, 0x72, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x66, 0x61, 
	0x74, 0x6D, 0x73, 0x6D, 0x6F, 0x64, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x77, 
	0x6C, 0x61, 0x6E, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 0x76, 0x61, 0x75, 0x64, 
	0x69, 0x6F, 0x5F, 0x67, 0x61, 0x6D, 0x65, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 0x64, 0x2F, 
	0x6D, 0x65, 0x64, 0x69, 0x61, 0x73, 0x79, 0x6E, 0x63, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 0x6B, 
	0x64, 0x2F, 0x72, 0x65, 0x67, 0x69, 0x73, 0x74, 0x72, 0x79, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 
	0x6B, 0x64, 0x2F, 0x75, 0x74, 0x69, 0x6C, 0x69, 0x74, 0x79, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x2F, 
	0x6B, 0x64, 0x2F, 0x6D, 0x65, 0x73, 0x67, 0x5F, 0x6C, 0x65, 0x64, 0x2E, 0x70, 0x72, 0x78, 0x0A, 
	0x2F, 0x6B, 0x64, 0x2F, 0x69, 0x6D, 0x70, 0x6F, 0x73, 0x65, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x25, 
	0x2F, 0x6B, 0x64, 0x2F, 0x75, 0x73, 0x65, 0x72, 0x73, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x6C, 0x69, 
	0x62, 0x2E, 0x70, 0x72, 0x78, 0x0A, 0x25, 0x25, 0x2F, 0x6B, 0x64, 0x2F, 0x64, 0x75, 0x6D, 0x6D, 
	0x79, 0x5F, 0x61, 0x6E, 0x63, 0x68, 0x6F, 0x72, 0x5F, 0x49, 0x68, 0x61, 0x72, 0x69, 0x55, 0x61, 
	0x66, 0x61, 0x61, 0x79, 0x6B, 0x39, 0x38, 0x2E, 0x70, 0x72, 0x78, 0x0A
};

u8 uart4[1402] = 
{
	0x7F, 0x45, 0x4C, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xA0, 0xFF, 0x08, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 
	0xF0, 0x01, 0x00, 0x00, 0x01, 0x30, 0xA2, 0x10, 0x34, 0x00, 0x20, 0x00, 0x01, 0x00, 0x28, 0x00, 
	0x10, 0x00, 0x0F, 0x00, 0x01, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xA0, 0x00, 0x00, 0x00, 0x90, 0x01, 0x00, 0x00, 0x90, 0x01, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 
	0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x0D, 0x34, 0x03, 0x3C, 0x01, 0x88, 0x02, 0x3C, 0x01, 0x00, 0x63, 0x34, 0xE0, 0x52, 0x42, 0x34, 
	0x00, 0x00, 0x43, 0xAC, 0x08, 0x00, 0xE0, 0x03, 0x21, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x04, 0x01, 0x01, 0x00, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x07, 0x00, 0x00, 0x01, 0x6C, 0x63, 0x70, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x80, 0x81, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 
	0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xDB, 0xAC, 0x32, 0xD6, 0xA7, 0x73, 0x1D, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x07, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 
	0x7C, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x02, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x1D, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x70, 0x04, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 
	0x04, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x02, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x37, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 
	0x94, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x45, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x02, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x98, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x53, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 
	0xA0, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x69, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x00, 0x70, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x04, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
	0x83, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
	0xE0, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x97, 0x00, 0x00, 0x00, 0xA0, 0x00, 0x00, 0x70, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA0, 0x04, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
	0xAF, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x90, 0x01, 0x00, 0x00, 
	0xF0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xB5, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
	0x03, 0x00, 0x00, 0x10, 0x90, 0x01, 0x00, 0x00, 0xF0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xBB, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x90, 0x01, 0x00, 0x00, 
	0xF0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xB0, 0x04, 0x00, 0x00, 0xCA, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x2C, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 
	0x64, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 
	0x6C, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 
	0x88, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x8C, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 
	0x00, 0x2E, 0x74, 0x65, 0x78, 0x74, 0x00, 0x2E, 0x6C, 0x69, 0x62, 0x2E, 0x65, 0x6E, 0x74, 0x2E, 
	0x74, 0x6F, 0x70, 0x00, 0x2E, 0x6C, 0x69, 0x62, 0x2E, 0x65, 0x6E, 0x74, 0x00, 0x2E, 0x72, 0x65, 
	0x6C, 0x2E, 0x6C, 0x69, 0x62, 0x2E, 0x65, 0x6E, 0x74, 0x00, 0x2E, 0x6C, 0x69, 0x62, 0x2E, 0x65, 
	0x6E, 0x74, 0x2E, 0x62, 0x74, 0x6D, 0x00, 0x2E, 0x6C, 0x69, 0x62, 0x2E, 0x73, 0x74, 0x75, 0x62, 
	0x2E, 0x74, 0x6F, 0x70, 0x00, 0x2E, 0x6C, 0x69, 0x62, 0x2E, 0x73, 0x74, 0x75, 0x62, 0x2E, 0x62, 
	0x74, 0x6D, 0x00, 0x2E, 0x72, 0x6F, 0x64, 0x61, 0x74, 0x61, 0x2E, 0x73, 0x63, 0x65, 0x4D, 0x6F, 
	0x64, 0x75, 0x6C, 0x65, 0x49, 0x6E, 0x66, 0x6F, 0x00, 0x2E, 0x72, 0x65, 0x6C, 0x2E, 0x72, 0x6F, 
	0x64, 0x61, 0x74, 0x61, 0x2E, 0x73, 0x63, 0x65, 0x4D, 0x6F, 0x64, 0x75, 0x6C, 0x65, 0x49, 0x6E, 
	0x66, 0x6F, 0x00, 0x2E, 0x72, 0x6F, 0x64, 0x61, 0x74, 0x61, 0x2E, 0x73, 0x63, 0x65, 0x52, 0x65, 
	0x73, 0x69, 0x64, 0x65, 0x6E, 0x74, 0x00, 0x2E, 0x72, 0x65, 0x6C, 0x2E, 0x72, 0x6F, 0x64, 0x61, 
	0x74, 0x61, 0x2E, 0x73, 0x63, 0x65, 0x52, 0x65, 0x73, 0x69, 0x64, 0x65, 0x6E, 0x74, 0x00, 0x2E, 
	0x64, 0x61, 0x74, 0x61, 0x00, 0x2E, 0x73, 0x62, 0x73, 0x73, 0x00, 0x2E, 0x62, 0x73, 0x73, 0x00, 
	0x2E, 0x73, 0x68, 0x73, 0x74, 0x72, 0x74, 0x61, 0x62, 0x00
};

int main(int argc, char *argv[])
{
	int x;

	pspDebugScreenInit();

	if (CheckFirmware() < 0)
	{
		ErrorExit(5000, "This application doesn't apply to this firmware.\n");
	}	
	
	printf("This application will quickly flash a few files in your psp"
		   " to permanently enable no-kxploited eboots to run.\n");

	printf("Press X to do the patch.\n");

	while (1)
	{
		SceCtrlData pad;

		sceCtrlReadBufferPositive(&pad, 1);

		if (pad.Buttons & PSP_CTRL_CROSS)
			break;
	}

	if (sceIoUnassign("flash0:") < 0)
	{
		ErrorExit(5000, "Can't unassign flash0.\n");		
	}

	if (sceIoAssign("flash0:", "lflash0:0,0", "flashfat0:", IOASSIGN_RDWR, NULL, 0) < 0)
	{
		ErrorExit(5000, "Can't assign flash0.\n");
	}

	if (PatchModuleMgr() < 0)
	{
		ErrorExit(5000, "Error patching modulemgr (incorrect firmware?).\n");
	}

	if (WriteFile("flash0:/kd/patcher.prx", uart4, sizeof(uart4)) != sizeof(uart4))
	{
		ErrorExit(5000, "Cannot write pspbtcnf_game.txt.\n");
	}

	if (WriteFile("flash0:/kd/pspbtcnf_game.txt", pspbtcnf_game, sizeof(pspbtcnf_game)) != sizeof(pspbtcnf_game))
	{
		ErrorExit(5000, "Cannot write pspbtcnf_game.txt.\n");
	}

	ErrorExit(5000, "Patch succesfull.\n");

	return 0;
}
