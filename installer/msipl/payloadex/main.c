#include <pspsdk.h>

#include "psp_uart.h"
#include "fat.h"

#define JAL_OPCODE	0x0C000000
#define J_OPCODE	0x08000000

#define MAKE_JUMP(a, f) _sw(J_OPCODE | (((u32)(f) & 0x0ffffffc) >> 2), a); 
#define MAKE_CALL(a, f) _sw(JAL_OPCODE | (((u32)(f) >> 2)  & 0x03ffffff), a); 

int (* Ipl_Payload)(void *, void *, void*, void *) = (void *)0x88400000;
int (* Kprintf)(const char *format, ...) = (void *)0x88413bb8;
int (* Dcache)(void) = (void *)0x8841bef0;
int (* Icache)(void) = (void *)0x8841bb20;

void ClearCaches()
{
	Dcache();
	Icache();
}

int SysMemStart(SceSize args, void *argp, int (* module_start)(SceSize, void *))
{
	Kprintf("Starting sysmem...\n");
	return module_start(4, argp);
}

int LoadCoreStart(SceSize args, void *argp, int (* module_start)(SceSize, void *))
{	
	u32 text_addr = ((u32)module_start) - 0x0AB8;

	// NoPlainModuleCheckPatch (mfc0 $t5, $22 -> li $t5, 1)
	_sw(0x340D0001, text_addr+0x2FE0);
	
	/* NoPlainPspConfigCheckPatch */
	
	// mfc0 $a1, $22 -> nop
	_sw(0, text_addr+0x284C);
	// li $a0, 0xFFFFFFFF -> mov $a0, $a1 -> (a0 = -1 -> a0 = filesize)
	_sw(0x00052021, text_addr+0x285C);

	ClearCaches();
	Kprintf("Starting loadcore...\n");
	return module_start(8, argp);
}

u8 key[32] = 
{
	0x1F, 0x2C, 0xA4, 0x61, 0x85, 0x8D, 0xC3, 0x1C, 0xB6, 0x4E, 0x0F, 0xB3, 0x6A, 0xF9, 0x3C, 0x39, 
	0x7E, 0xEF, 0x75, 0x9F, 0x66, 0x44, 0x12, 0x42, 0xEA, 0xFF, 0x54, 0x5F, 0xEA, 0xC3, 0xEC, 0x47
};

u8 authors[140] = 
{
	0x4F, 0x4D, 0xCA, 0x05, 0xEA, 0xFF, 0xBA, 0x3B, 0xC5, 0x6E, 0x4D, 0xD2, 0x1E, 0x8D, 0x59, 0x4B, 
	0x07, 0xCF, 0x34, 0xEA, 0x12, 0x2C, 0x7D, 0x30, 0x99, 0xC5, 0x74, 0x11, 0x8F, 0xAE, 0xC0, 0x67, 
	0x75, 0x43, 0xC1, 0x0A, 0xA9, 0xAD, 0x85, 0x7D, 0xD8, 0x24, 0x66, 0xC7, 0x0B, 0xD5, 0x1C, 0x7A, 
	0x16, 0x9D, 0x1C, 0xEC, 0x4A, 0x64, 0x78, 0x2B, 0x87, 0xD3, 0x74, 0x2F, 0x99, 0xB3, 0xDE, 0x72, 
	0x2F, 0x00, 0x84, 0x41, 0xE1, 0xE4, 0xB7, 0x70, 0xD3, 0x39, 0x23, 0x93, 0x39, 0x92, 0x45, 0x55, 
	0x1F, 0x9D, 0x1E, 0xB3, 0x46, 0x00, 0x73, 0x30, 0x81, 0xA0, 0x15, 0x33, 0x8F, 0x9B, 0xC0, 0x67, 
	0x72, 0x4D, 0xD0, 0x09, 0xEC, 0xE8, 0xB6, 0x70, 0xDE, 0x62, 0x2F, 0xC7, 0x13, 0x8B, 0x5D, 0x57, 
	0x17, 0x8B, 0x59, 0xBF, 0x07, 0x20, 0x60, 0x23, 0x82, 0x96, 0x38, 0x7F, 0x8B, 0xAD, 0x88, 0x67, 
	0x5D, 0x43, 0xCB, 0x12, 0xF1, 0xE8, 0xB1, 0x32, 0xBC, 0x44, 0x05, 0xB3
};

void Authors()
{
	u8 *out = (void *)0x883e0000;
	int i;

	for (i = 0; i < sizeof(authors); i++)
	{
		out[i] = authors[i];
	}
}

int entry(void *a0, void *a1, void *a2, void *a3)
{	
	// jal sysmem::module_start -> jal SysMemStart
	// li  $a0, 4 -> mov $a2, $s1  (a0 = 4 -> a2 = module_start)
	MAKE_CALL(0x884007e4, SysMemStart);
	_sw(0x02203021, 0x884007e8);
	
	// mov $a0, $s4 -> mov $a2, $v0 (a0 = 8 -> a2 = module_start)
	// mov $a1, $sp
	// jr  loadcore::module_start -> j LoadCoreStart 
	// mov $sp, $t3
	_sw(0x00403021, 0x884007c0);
	MAKE_JUMP(0x884007c8, LoadCoreStart);

	/* NoPlainPspConfigCheckPatch */
	
	// mfc0 $a1, $22 -> nop
	_sw(0, 0x8840d81c);
	// li   a0, 0xFFFFFFFF -> mov $a0, $a1 (a0 = -1 -> a0 = filesize)
	_sw(0x00052021, 0x8840d82c);
	// li   a3, 0xFFFFFFFF -> mov $a3, $a1 (return -1 -> return filesize)
	_sw(0x00053821, 0x8840d834);

	// NoPlainModuleCheckPatch (mfc0 t6, $22 -> li $t6, 1)
	_sw(0x240e0001, 0x8840df9c);

	/* Kprintf stuff */
	// Change default putc handler
	u32 addr = (u32)uart_dbg_putc;
	_sw(addr, 0x884255ac);
	_sh(addr >> 16, 0x884000bc);
	_sw(0x35440000 | (addr & 0xFFFF), 0x884000c4);
	// Patch removeByDebugSection, make it return 1	
	_sw(0x03e00008, 0x884130b0);
	_sw(0x24020001, 0x884130b4);

	/* File open redirection */
	// Redirect sceBootLfatMount to MsFatMount
	MAKE_CALL(0x8840111c, MsFatMount);
	// Redirect sceBootLfatOpen to MsFatOpen
	MAKE_CALL(0x8840112c, MsFatOpen);
	// Redirect sceBootLfatRead to MsFatRead
	MAKE_CALL(0x8840115c, MsFatRead);
	// Redirect sceBootLfatClose to MsFatClose
	MAKE_CALL(0x8840117c, MsFatClose);

	Authors();

	ClearCaches();	

	Kprintf("Payloadex enter.\n");
	Kprintf("Booting kernel...\n");

	return Ipl_Payload(a0, a1, a2, a3);	
}

int main(){ return 0; }

