#include <pspsdk.h>
#include <pspkernel.h>
#include <pspdebug.h>
#include <pspctrl.h>
#include <pspsuspend.h>
#include <psppower.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <stdarg.h>
#include <systemctrl.h>

#include "plutonium.h"
#include "degeneration.h"

PSP_MODULE_INFO("plutonium_updater", 0x0800, 1, 0);
PSP_MAIN_THREAD_ATTR(PSP_THREAD_ATTR_VSH);

#define printf    pspDebugScreenPrintf
#define PROGRAM	  "ms0:/PSP/GAME/UPDATE/PUPD.PBP"

u8 buffer[1*1024*1024] __attribute__((aligned(64)));

u8 sce_updater_md5[16] = 
{
	0x64, 0xBA, 0xE5, 0xDD, 0x0D, 0x0F, 0x83, 0x6B, 
	0xAE, 0xDF, 0x91, 0x5F, 0xB1, 0x06, 0xE9, 0xCC
};

u8 umodule_md5[16] = 
{
	0x18, 0xA9, 0xC0, 0x69, 0x35, 0x4C, 0x46, 0xD6, 
	0x9D, 0xD1, 0xC9, 0x3F, 0x5B, 0xA8, 0x4D, 0x85
};


unsigned char vshmain_args[1024] = 
{
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


void ErrorExit(int milisecs, char *fmt, ...)
{
	va_list list;
	char msg[256];	

	va_start(list, fmt);
	vsprintf(msg, fmt, list);
	va_end(list);

	printf(msg);
	
	sceKernelDelayThread(milisecs*1000);
	sceKernelExitGame();
}

////////////////////////////////////////////////////////////////////
// File helpers

int ReadFile(char *file, int seek, void *buf, int size)
{
	SceUID fd = sceIoOpen(file, PSP_O_RDONLY, 0);
	if (fd < 0)
		return fd;

	if (seek > 0)
	{
		if (sceIoLseek(fd, seek, PSP_SEEK_SET) != seek)
		{
			sceIoClose(fd);
			return -1;
		}
	}

	int read = sceIoRead(fd, buf, size);
	
	sceIoClose(fd);
	return read;
}

int WriteFile(char *file, void *buf, int size)
{
	SceUID fd = sceIoOpen(file, PSP_O_WRONLY | PSP_O_CREAT | PSP_O_TRUNC, 0777);
	
	if (fd < 0)
	{
		return fd;
	}

	int written = sceIoWrite(fd, buf, size);

	sceIoClose(fd);
	return written;
}

SceUID LoadStartModule(void *buf, int size, void *param)
{
	SceUID mod = vshKernelLoadModuleBufferVSH(size, buf, 0, NULL);

	if (mod < 0)
		return mod;

	return sceKernelStartModule(mod, (param) ? 4 : 0, param, NULL, NULL);

}

SceUID LoadStartModuleFile(char *file)
{
	SceUID mod = vshKernelLoadModuleVSH(file, 0, NULL);

	if (mod < 0)
		return mod;

	return sceKernelStartModule(mod, 0, NULL, NULL, NULL);
}

int StopUnloadModule(SceUID mod)
{
	int res = sceKernelStopModule(mod, 0, NULL, NULL, NULL);
	if (res < 0)
		return res;

	return sceKernelUnloadModule(mod);
}

void VerifyFile(char *file, u8 *md5)
{
	SceKernelUtilsMd5Context ctx;
	SceUID fd;
	u8 calc_md5[16];
	int read;

	printf("Verifying %s... ", file);

	fd = sceIoOpen(file, PSP_O_RDONLY, 0);
	if (fd < 0)
	{
		ErrorExit(5000, "Cannot open file (0x%08X).\n", fd);
	}

	sceKernelUtilsMd5BlockInit(&ctx);

	while ((read = sceIoRead(fd, buffer, sizeof(buffer))) > 0)
	{
		sceKernelUtilsMd5BlockUpdate(&ctx, buffer, read);
	}

	sceIoClose(fd);

	sceKernelUtilsMd5BlockResult(&ctx, calc_md5);

	if (memcmp(md5, calc_md5, 16) != 0)
	{
		ErrorExit(5000, "Incorrect file.\n");
	}

	printf("OK\n");
}

int UnassignFlashes()
{
	int res = sceIoUnassign("flash0:");
	
	if (res < 0)
		return res;

	res = sceIoUnassign("flash1:");
	if (res < 0)
		return res;

	return 0;
}

int AssignFlashes()
{
	if (sceIoAssign("flash0:", "lflash0:0,0", "flashfat0:", IOASSIGN_RDWR, NULL, 0) < 0)
		return -1;

	if (sceIoAssign("flash1:", "lflash0:0,1", "flashfat1:", IOASSIGN_RDWR, NULL, 0) < 0)
		return -1;
	
	return 0;
}

int main()
{
	SceUID mod;
	int state;
	SceCtrlData pad;
	u32 oldbuttons = 0;
	int res;
	char *argv[2];
	int bypass = 0;

	sceCtrlReadBufferPositive(&pad, 1);

	if ((pad.Buttons & PSP_CTRL_LTRIGGER) && (pad.Buttons & PSP_CTRL_TRIANGLE))
	{
		bypass = 1;
	}
	
	pspDebugScreenInit();	

	sceIoChdir("ms0:/PSP/GAME/UPDATE");

	if (sceKernelDevkitVersion() < 0x03060010)
	{
		if (sceKernelDevkitVersion() < 0x03050210)
		{
			ErrorExit(5000, "This program requires 3.52 M33-3 or higher.\n");
		}
		
		if (ReadFile("flash0:/kd/systemctrl.prx", 0x150, buffer, 16) < 0)
		{
			ErrorExit(5000, "This program requires 3.52 M33-3 or higher.\n");
		}

		if (buffer[0] == 0x1F && buffer[1] == 0x8B)
		{
			ErrorExit(5000, "This program requires 3.52 M33-3 or higher.\n");
		}
	}

	if (!bypass)
	{
		if (scePowerGetBatteryLifePercent() < 78)
		{
			ErrorExit(5000, "Battery has to be at least at 78%%.\n");
		}
	}

	res = sceIoAssign("flash2:", "lflash0:0,2", "flashfat2:", IOASSIGN_RDWR, NULL, 0);
	if (res == 0x80010005 || res == 0x80020321)
	{
		printf("Flash2 is unformatted.\n");
		printf("Formatting flash2.... ");

		if (LoadStartModuleFile("flash0:/kd/lflash_fatfmt.prx") < 0)
			ErrorExit(500, "Error loading lflash_fatfmt.");

		if (UnassignFlashes() < 0)
			ErrorExit(5000, "Error unassigning flashes.");

		argv[0] = "fatfmt";
		argv[1] = "lflash0:0,2";

		if (vshLflashFatfmtStartFatfmt(2, argv) < 0)
			ErrorExit(5000, "Error in lflash_fatfmt.");

		if (AssignFlashes() < 0)
			ErrorExit(5000, "Error reassigning flashes.");

		printf("OK\n");
		sceKernelDelayThread(200000);

		printf("Restarting app...\n");

		struct SceKernelLoadExecVSHParam param;

		memset(&param, 0, sizeof(param));			
		param.size = sizeof(param);
		param.args = strlen(PROGRAM)+1;
		param.argp = PROGRAM;
		param.key = "updater";
	
		sctrlKernelLoadExecVSHMs1(PROGRAM, &param);
	}
	else if (res >= 0)
	{
		sceIoUnassign("flash2:");
	}

	VerifyFile("390.PBP", sce_updater_md5);
	VerifyFile("u235.prx", umodule_md5);

	printf("\n");

	mod = LoadStartModule(degeneration, sizeof(degeneration), NULL);

	if (mod < 0)
	{
		ErrorExit(5000, "Error 0x%08X loading degeneration.\n", mod);
	}

	state = pspDegCheckDegenerationState();

	if (state < 0)
	{
		ErrorExit(5000, "Error 0x%08X checking idstorage degeneration.\n");
	}

	else if (state != 0)
	{
		printf("Some of your idstorage keys have not the correct values, probably due "
			   "to a downgrader. In order to continue, press X to restore the correct values, press R to exit.\n\n");

		while (1)
		{
			sceCtrlReadBufferPositive(&pad, 1);

			if (pad.Buttons != oldbuttons)
			{
				if (pad.Buttons & PSP_CTRL_CROSS)
				{
					oldbuttons = pad.Buttons;
					break;
				}

				else if (pad.Buttons & PSP_CTRL_RTRIGGER)
					ErrorExit(5000, "Update canceled by user.\n");
			}

			oldbuttons = pad.Buttons;
			sceKernelDelayThread(10000);
		}		

		state = pspDegCorrectDegeneration(state);

		if (state < 0)
		{
			ErrorExit(5000, "Fail in idstorage correction!\n");
		}

		sceKernelDelayThread(800000);
		printf("Idstorage corrected succesfully.\n\n");
	}

	printf("Press X to start the update, R to exit.\n\n");

	while (1)
	{
		sceCtrlReadBufferPositive(&pad, 1);

		if (pad.Buttons != oldbuttons)
		{
			if (pad.Buttons & PSP_CTRL_CROSS)
				break;

			else if (pad.Buttons & PSP_CTRL_RTRIGGER)
				ErrorExit(5000, "Update canceled by user.\n");
		}

		oldbuttons = pad.Buttons;
		sceKernelDelayThread(10000);
	}

	if (StopUnloadModule(mod) < 0)
		ErrorExit(5000, "Error unloading degeneration.\n");

	mod = LoadStartModule(plutonium, sizeof(plutonium), &bypass);

	if (mod < 0)
		ErrorExit(5000, "Error 0x%08X loading plutonium.\n");

	printf("Starting sce updater. Wait...\n");
	sceKernelDelayThread(500000);

	PlutoniumStartUpdate(0, NULL);
	
	sceKernelExitDeleteThread(0);
	
	return 0;
}

